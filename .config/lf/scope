#!/usr/bin/sh
# @author nate zhou
# @since 2025
# previewer for lf
# @depends chafa

# move temp file to memory instead of writting to disk
CACHE_DIR="/tmp/$USER"
CACHE="/tmp/$USER/lf-scope"
[ -d "$CACHE_DIR" ] || mkdir -m 700 "$CACHE"

show_img(){
    if [ "$XDG_SESSION_TYPE" != "tty" ]; then
        /usr/bin/chafa -f sixel -s "$2x$3" --animate off --polite on -t 1 --bg '#111111' "$1"
    else
        catimg -t -w "$2" "$1"
    fi
}

case "$(file -Lb --mime-type -- "$1")" in
    image/*xcf)
        exiftool "$1" | "$PAGER"
        ;;
    image/*)
        show_img "$1" "$2" "$3"
        ;;
    video/*)
        /usr/bin/ffmpegthumbnailer -i "$1" -s 240 -q 5 -o "$CACHE"
        show_img "$CACHE" "$2" "$3"
        ;;
    audio/*)
        mediainfo "$1"
        ;;
    application/epub+zip)
        /usr/bin/gnome-epub-thumbnailer "$1" "$CACHE".png
        show_img "$CACHE".png "$2" "$3"
        ;;
    application/pdf)
        /usr/bin/pdftoppm -f 1 -l 1 -singlefile -jpeg "$1" "$CACHE"
        show_img "$CACHE".jpg "$2" "$3"
        ;;
    application/zip)
        zipinfo "$1" | "$PAGER"
        ;;
    application/*tar|application/*zip*|application/zstd|application/*xz)
        tar vvtf "$1" | "$PAGER"
        ;;
    text/html)
        w3m "$1"
        ;;
    text/*)
        bat --color always --style="plain" "$1"
        ;;
    application/octet-stream)
        file -b "$1"
        ;;
    *)
        cat "$1"
        ;;
esac

exit1
